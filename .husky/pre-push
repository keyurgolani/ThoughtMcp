echo "ğŸš€ Running pre-push validations..."

current_branch=$(git rev-parse --abbrev-ref HEAD)

# Check for technical debt violations
echo "ğŸ” Checking for technical debt violations..."

# Check for 'any' types (forbidden)
ANY_FOUND=$(find src -name "*.ts" -exec grep -l ": any\|as any\|any\[\]\|<any>" {} \; 2>/dev/null)
if [ -n "$ANY_FOUND" ]; then
  echo "âŒ Forbidden 'any' types found in:"
  echo "$ANY_FOUND"
  exit 1
fi

# Check for suppression comments (forbidden)
SUPPRESSIONS=$(find src -name "*.ts" -exec grep -l "@ts-ignore\|@ts-expect-error\|eslint-disable" {} \; 2>/dev/null)
if [ -n "$SUPPRESSIONS" ]; then
  echo "âŒ Forbidden suppression comments found in:"
  echo "$SUPPRESSIONS"
  exit 1
fi

# Check for alternative file versions (forbidden)
ALT_FILES=$(find src -name "*-v2.ts" -o -name "*-new.ts" -o -name "*-old.ts" -o -name "*-temp.ts" -o -name "*-backup.ts" -o -name "*-enhanced.ts" -o -name "*-improved.ts" 2>/dev/null)
if [ -n "$ALT_FILES" ]; then
  echo "âŒ Forbidden alternative file versions found:"
  echo "$ALT_FILES"
  exit 1
fi

# Run full build with all quality gates
echo "ğŸ—ï¸  Running full build with quality gates..."
timeout 180s npm run build
if [ $? -ne 0 ]; then
  echo "âŒ Build failed. Please fix the issues above."
  exit 1
fi

# Additional checks for protected branches
if [ "$current_branch" = "main" ] || [ "$current_branch" = "master" ]; then
  echo "ğŸ”’ Protected branch: $current_branch"
  if git log --oneline -5 | grep -E "(bump|version|release|v[0-9])" > /dev/null; then
    echo "âœ… Version update detected."
  else
    echo "âš ï¸  No version update detected. Consider bumping version."
  fi
fi

echo "âœ… Pre-push validations passed!"
