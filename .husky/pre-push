echo "ğŸš€ Running pre-push validations..."

current_branch=$(git rev-parse --abbrev-ref HEAD)

# Check for sensitive files in staged changes
echo "ğŸ” Checking for sensitive files..."
if git diff --name-only HEAD~1..HEAD 2>/dev/null | grep -E "\.(key|pem|p12|pfx)$|\.env$|\.env\.(local|development|test|production)$" > /dev/null; then
  echo "âŒ Attempting to push sensitive files. Please remove them from the commit."
  git diff --name-only HEAD~1..HEAD | grep -E "\.(key|pem|p12|pfx)$|\.env$|\.env\.(local|development|test|production)$"
  exit 1
fi

# Check for alternative file versions (forbidden)
echo "ğŸ” Checking for forbidden file patterns..."
ALT_FILES=$(find src -name "*-v2.ts" -o -name "*-new.ts" -o -name "*-old.ts" -o -name "*-temp.ts" -o -name "*-backup.ts" -o -name "*-enhanced.ts" -o -name "*-improved.ts" 2>/dev/null)
if [ -n "$ALT_FILES" ]; then
  echo "âŒ Forbidden alternative file versions found:"
  echo "$ALT_FILES"
  exit 1
fi

# Run full validation with strict linting (same as CI)
echo "ğŸ—ï¸  Running CI validation..."
timeout 220s npm run validate:ci
if [ $? -ne 0 ]; then
  echo "âŒ CI validation failed. Please fix the issues above."
  echo "ğŸ’¡ CI validation includes: security audit, format check, strict lint (zero warnings), typecheck, tests with coverage."
  exit 1
fi

# Build the project
echo "ğŸ“¦ Building project..."
timeout 120s npm run build:quick
if [ $? -ne 0 ]; then
  echo "âŒ Build failed. Please fix the issues above."
  exit 1
fi

# Additional checks for protected branches
if [ "$current_branch" = "main" ] || [ "$current_branch" = "master" ]; then
  echo "ğŸ”’ Protected branch: $current_branch"
  if git log --oneline -5 | grep -E "(bump|version|release|v[0-9])" > /dev/null; then
    echo "âœ… Version update detected."
  else
    echo "âš ï¸  No version update detected. Consider bumping version."
  fi
fi

echo "âœ… Pre-push validations passed!"
