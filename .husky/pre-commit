#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ” Running pre-commit validations..."

# Check if we're in strict mode (set STRICT_PRECOMMIT=1 to enable)
STRICT_MODE=${STRICT_PRECOMMIT:-0}

# Run linting (strict mode treats warnings as errors)
if [ "$STRICT_MODE" = "1" ]; then
  echo "ğŸ“ Checking code style (strict mode - no warnings allowed)..."
  npm run lint:strict
else
  echo "ğŸ“ Checking code style..."
  npm run lint
fi

if [ $? -ne 0 ]; then
  echo "âŒ Linting failed. Please fix the issues above."
  if [ "$STRICT_MODE" = "0" ]; then
    echo "ğŸ’¡ Tip: Set STRICT_PRECOMMIT=1 to treat warnings as errors"
  fi
  exit 1
fi

# Run type checking
echo "ğŸ” Type checking..."
npm run type-check
if [ $? -ne 0 ]; then
  echo "âŒ Type checking failed. Please fix the type errors above."
  exit 1
fi

# Check for 'any' types in staged TypeScript files
echo "ğŸ” Checking for 'any' types in staged files..."
ANY_COUNT=$(git diff --cached --name-only | grep "\.ts$" | xargs grep -n ": any\|as any\|any\[\]" 2>/dev/null | wc -l)
if [ $ANY_COUNT -gt 0 ]; then
  echo "âš ï¸  Found $ANY_COUNT 'any' types in staged TypeScript files:"
  git diff --cached --name-only | grep "\.ts$" | xargs grep -n ": any\|as any\|any\[\]" 2>/dev/null | head -5
  if [ "$STRICT_MODE" = "1" ]; then
    echo "âŒ Strict mode: 'any' types not allowed. Please specify proper types."
    exit 1
  else
    echo "ğŸ’¡ Consider replacing 'any' with specific types for better type safety."
  fi
fi

# Run tests on affected files
echo "ğŸ§ª Running tests..."
npm run test:run
if [ $? -ne 0 ]; then
  echo "âŒ Tests failed. Please fix the failing tests above."
  exit 1
fi

# Check for sensitive files
echo "ğŸ”’ Checking for sensitive files..."
if git diff --cached --name-only | grep -E "\.(key|pem|p12|pfx)$|\.env$|\.env\." > /dev/null; then
  echo "âŒ Attempting to commit sensitive files. Please remove them from the commit."
  git diff --cached --name-only | grep -E "\.(key|pem|p12|pfx)$|\.env$|\.env\."
  exit 1
fi

# Check for console.log/debugger statements
echo "ğŸ› Checking for debug statements..."
DEBUG_COUNT=$(git diff --cached | grep -E "^\+.*\b(console\.(log|debug|info|warn|error)|debugger)\b" | wc -l)
if [ $DEBUG_COUNT -gt 0 ]; then
  echo "âš ï¸  Found $DEBUG_COUNT debug statements in staged changes:"
  git diff --cached | grep -E "^\+.*\b(console\.(log|debug|info|warn|error)|debugger)\b" | head -3
  if [ "$STRICT_MODE" = "1" ]; then
    echo "âŒ Strict mode: Debug statements not allowed in commits."
    exit 1
  else
    echo "ğŸ’¡ Consider removing debug statements before committing."
  fi
fi

# Check for TODO/FIXME in staged files
echo "ğŸ“‹ Checking for TODO/FIXME comments..."
TODO_COUNT=$(git diff --cached | grep -E "^\+.*\b(TODO|FIXME|XXX|HACK)\b" | wc -l)
if [ $TODO_COUNT -gt 0 ]; then
  echo "âš ï¸  Found $TODO_COUNT TODO/FIXME comments in staged changes:"
  git diff --cached | grep -E "^\+.*\b(TODO|FIXME|XXX|HACK)\b" | head -5
  echo "ğŸ’¡ Consider addressing these before committing or create issues to track them."
fi

# Check for proper commit message format (if available)
if [ -f ".gitmessage" ]; then
  echo "ğŸ“ Commit message template available. Use 'git commit' without -m for guided format."
fi

echo "âœ… Pre-commit validations passed!"
if [ "$STRICT_MODE" = "1" ]; then
  echo "ğŸ”’ Strict mode was enabled - all quality checks passed!"
fi