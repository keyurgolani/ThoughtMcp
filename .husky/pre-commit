#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "üîç Running pre-commit validations..."

# Run linting
echo "üìù Checking code style..."
npm run lint
if [ $? -ne 0 ]; then
  echo "‚ùå Linting failed. Please fix the issues above."
  exit 1
fi

# Run type checking
echo "üîç Type checking..."
npm run type-check
if [ $? -ne 0 ]; then
  echo "‚ùå Type checking failed. Please fix the type errors above."
  exit 1
fi

# Run tests
echo "üß™ Running tests..."
npm run test:run
if [ $? -ne 0 ]; then
  echo "‚ùå Tests failed. Please fix the failing tests above."
  exit 1
fi

# Check for sensitive files
echo "üîí Checking for sensitive files..."
if git diff --cached --name-only | grep -E "\.(key|pem|p12|pfx)$|\.env$" > /dev/null; then
  echo "‚ùå Attempting to commit sensitive files. Please remove them from the commit."
  git diff --cached --name-only | grep -E "\.(key|pem|p12|pfx)$|\.env$"
  exit 1
fi

# Check for TODO/FIXME in staged files
echo "üìã Checking for TODO/FIXME comments..."
TODO_COUNT=$(git diff --cached | grep -E "^\+.*\b(TODO|FIXME|XXX|HACK)\b" | wc -l)
if [ $TODO_COUNT -gt 0 ]; then
  echo "‚ö†Ô∏è  Found $TODO_COUNT TODO/FIXME comments in staged changes:"
  git diff --cached | grep -E "^\+.*\b(TODO|FIXME|XXX|HACK)\b" | head -5
  echo "Consider addressing these before committing."
fi

echo "‚úÖ Pre-commit validations passed!"